<!DOCTYPE html>
<html lang="ja">

<!--
MUI + TanStack Query(React Query) + TanStack Table(React Table)を使って編集機能をつけてみた。
まだバリデーションなし
-->

<head>
  <title>ReactCDN</title>
  <meta charset="utf-8">
  <meta name="viewport" content="initail-scale=1, width=device-width">
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin="anonymous"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@mui/material@latest/umd/material-ui.development.js" crossorigin="anonymous"></script>
  <script src='https://unpkg.com/react-router-dom@5/umd/react-router-dom.min.js'></script>
  <script src="https://unpkg.com/@tanstack/react-query@4/build/umd/index.production.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tanstack/react-table@8.7.0/build/umd/index.development.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js" crossorigin="anonymous"></script>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700&display=swap" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
</head>

<body>
  <div id="app"></div>
  <script type="text/babel">
    const fetcher = url => axios.get(url).then(res => res.data)

    const useFetchUsers = () => {
      const { useQuery } = ReactQuery
      return useQuery({
        queryKey: ['users'],
        queryFn: async () => fetcher('https://jsonplaceholder.typicode.com/users')
      })
    }

    function useSkipper() {
      const shouldSkipRef = React.useRef(true)
      const shouldSkip = shouldSkipRef.current

      // Wrap a function with this to skip a pagination reset temporarily
      const skip = React.useCallback(() => {
        shouldSkipRef.current = false
      }, [])

      React.useEffect(() => {
        shouldSkipRef.current = true
      })

      return [shouldSkip, skip]
    }

    const NEditableCellTable = (props) => {
      const { useState, useEffect } = React
      const { flexRender, getCoreRowModel, getFilteredRowModel, getPaginationRowModel, useReactTable } = ReactTable
      const { TableContainer, Table, TableHead, TableRow, TableCell, TableBody, TablePagination } = MaterialUI
      const { Box, Input, IconButton, Icon, Button } = MaterialUI

      const { columns } = props
      const [data, setData] = useState(props.data)
      const [autoResetPageIndex, skipAutoResetPageIndex] = useSkipper()

      const TablePaginationActions = (props) => {
        const { Box, IconButton, Icon } = MaterialUI
        const { count, page, rowsPerPage, onPageChange } = props

        const LastPageIcon = () => <Icon>last_page</Icon>
        const FirstPageIcon = () => <Icon>first_page</Icon>
        const KeyboardArrowLeft = () => <Icon>keyboard_arrow_left</Icon>
        const KeyboardArrowRight = () => <Icon>keyboard_arrow_right</Icon>

        const handleFirstPageButtonClick = (event) => {
          onPageChange(event, 0)
        }

        const handleBackButtonClick = (event) => {
          onPageChange(event, page - 1)
        }

        const handleNextButtonClick = (event) => {
          onPageChange(event, page + 1)
        }

        const handleLastPageButtonClick = (event) => {
          onPageChange(event, Math.max(0, Math.ceil(count / rowsPerPage) - 1))
        }

        return (
          <Box sx={{ flexShrink: 0, ml: 2.5 }}>
            <IconButton
              onClick={handleFirstPageButtonClick}
              disabled={page === 0}
              aria-label="first page"
            >
              <FirstPageIcon />
            </IconButton>
            <IconButton
              onClick={handleBackButtonClick}
              disabled={page === 0}
              aria-label="previous page"
            >
              <KeyboardArrowLeft />
            </IconButton>
            <IconButton
              onClick={handleNextButtonClick}
              disabled={page >= Math.ceil(count / rowsPerPage) - 1}
              aria-label="next page"
            >
              <KeyboardArrowRight />
            </IconButton>
            <IconButton
              onClick={handleLastPageButtonClick}
              disabled={page >= Math.ceil(count / rowsPerPage) - 1}
              aria-label="last page"
            >
              <LastPageIcon />
            </IconButton>
          </Box>
        )
      }

      const defaultColumn = {
        cell: ({ getValue, row: { index }, column: { id }, table }) => {
          const initialValue = getValue()
          const [value, setValue] = useState(initialValue)
          const [editmode, setEditMode] = useState(false)

          return (
            <>
              {!editmode ?
                <>
                  {value}
                  <IconButton size="small" sx={{ p: 0, mx: 2 }} onClick={() => setEditMode(true)}>
                    <Icon fontSize="small">edit</Icon>
                  </IconButton>
                </>
                :
                <>
                  <Input value={value} onChange={(e) => setValue(e.target.value)} />
                  <IconButton size="small" sx={{ p: 0 }} onClick={() => {
                    table.options.meta?.updateData(index, id, value)
                    setEditMode(false)
                  }}>
                    <Icon fontSize="small">check_circle</Icon>
                  </IconButton>
                  <IconButton size="small" sx={{ p: 0 }} onClick={() => {
                    setValue(initialValue)
                    setEditMode(false)
                  }}>
                    <Icon fontSize="small">cancel</Icon>
                  </IconButton>
                </>
              }
            </>
          )
        }
      }

      const table = useReactTable({
        data,
        columns,
        getCoreRowModel: getCoreRowModel(),
        defaultColumn,
        getFilteredRowModel: getFilteredRowModel(),
        getPaginationRowModel: getPaginationRowModel(),
        autoResetPageIndex,
        debugTable: true,
        meta: {
          updateData: (rowIndex, columnId, value) => {
            skipAutoResetPageIndex()
            setData(old =>
              old.map((row, index) => {
                if (index === rowIndex) {
                  return { ...old[rowIndex], [columnId]: value }
                }
                return row
              })
            )
            console.log(`table update data index:`, rowIndex, 'columnId:', columnId, 'value:', value);
          }
        }
      })

      const { pageSize, pageIndex } = table.getState().pagination

      const handleSubmit = (e) => alert(JSON.stringify(data, null, 2))

      return (
        <>
          <TableContainer>
            <Table>
              <TableHead>
                {table.getHeaderGroups().map((headerGroup) => (
                  <TableRow key={headerGroup.id}>
                    {headerGroup.headers.map((header) => (
                      <TableCell key={header.id} colSpan={header.colSpan}>
                        {header.isPlaceholder ? null : flexRender(header.column.columnDef.header, header.getContext())}
                      </TableCell>
                    ))}
                  </TableRow>
                ))}
              </TableHead>
              <TableBody>
                {table.getRowModel().rows.map((row) => (
                  <TableRow key={row.id}>
                    {row.getVisibleCells().map((cell) => (
                      <TableCell key={cell.id} size="small">
                        {flexRender(cell.column.columnDef.cell, cell.getContext())}
                      </TableCell>
                    ))}
                  </TableRow>
                ))}
              </TableBody>
            </Table>
          </TableContainer>
          <TablePagination
            rowsPerPageOptions={[5, 10, 25, { label: 'All', value: data.length }]}
            component="div"
            count={table.getFilteredRowModel().rows.length}
            rowsPerPage={pageSize}
            page={pageIndex}
            SelectProps={{
              inputProps: { 'aria-label': 'rows per page' },
              native: true,
            }}
            onPageChange={(_, page) => {
              table.setPageIndex(page)
            }}
            onRowsPerPageChange={e => {
              const size = e.target.value ? Number(e.target.value) : 10
              table.setPageSize(size)
            }}
            ActionsComponent={TablePaginationActions}
          />

          <Box textAlign="center" mt={2}>
            <Button color="primary" variant="contained" disableElevation onClick={handleSubmit}>
              設定
            </Button>
          </Box>

          <pre>{JSON.stringify(data, null, 2)}</pre>
          <pre>{JSON.stringify(table.getState().pagination, null, 2)}</pre>
        </>
      )
    }

    const Main = () => {
      const { useState, useEffect, useMemo } = React
      const { Container, Card, CardHeader, CardContent } = MaterialUI
      const { data, isLoading, error } = useFetchUsers()

      const columns = useMemo(() => [
        { accessorKey: 'id', header: 'ID', cell: row => row.getValue() }, //editableにしたくない場合はcellを値表示のみにする。
        { accessorKey: 'name', header: 'Name' },
        { accessorKey: 'username', header: 'Username' },
        { accessorKey: 'email', header: 'Email' }
      ], [])

      if (isLoading) return '<p>Loading...</p>'
      if (error) return '<p>An error has occurred: ' + error.message + '</p>'

      return (
        <Container sx={{ pt: 2 }}>
          <Card>
            <CardHeader title="ユーザ一覧" subheader="MUI + ReactQuery + ReactTable" />
            <CardContent>
              <NEditableCellTable columns={columns} data={data} />
            </CardContent>
          </Card>
        </Container>
      )
    }

    const App = () => {
      const { QueryClient, QueryClientProvider } = ReactQuery
      const { createTheme, ThemeProvider, CssBaseline } = MaterialUI

      const queryClient = new QueryClient()

      const theme = createTheme({
        palette: {
          primary: { light: '#63ccff', main: '#009be5', dark: '#006db3' },
          background: { default: '#f5f5f5' }
        }
      })
      return (
        <React.StrictMode>
          <QueryClientProvider client={queryClient}>
            <ThemeProvider theme={theme}>
              <CssBaseline />
              <Main />
            </ThemeProvider >
          </QueryClientProvider>
        </React.StrictMode>
      )
    }
    const container = document.getElementById('app')
    const root = ReactDOM.createRoot(container)
    root.render(<App />)
  </script>
</body>

</html>
