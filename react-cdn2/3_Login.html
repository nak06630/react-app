<!DOCTYPE html>
<html lang="ja">
<head>
  <title>ReactCDN</title>
  <meta charset="utf-8">
  <meta name="viewport" content="initail-scale=1, width=device-width">
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin="anonymous"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@mui/material@latest/umd/material-ui.development.js" crossorigin="anonymous"></script>
  <script src="https://unpkg.com/amazon-cognito-identity-js@6/dist/amazon-cognito-identity.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/react-hook-form@7/dist/index.umd.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js" crossorigin="anonymous"></script>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700&display=swap" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
</head>
<body>
  <div id="app"></div>
  <script type="text/babel">
    const poolData = { UserPoolId: "ap-northeast-1_mEDAZ9b89", ClientId: "6ccgqbuq83h89sv49vd8m0krod" }

    const useCognito = () => {
      const { CognitoUserPool, CognitoUser, AuthenticationDetails } = AmazonCognitoIdentity
      const userPool = new CognitoUserPool(poolData)

      const signIn = async (username, password) => {
        const cognitoUser = new CognitoUser({ Username: username, Pool: userPool })
        const authenticationDetails = new AuthenticationDetails({ Username: username, Password: password })
        return new Promise((resolve, reject) => {
          cognitoUser.authenticateUser(authenticationDetails, {
            onSuccess: result => resolve(result),
            onFailure: err => reject(err)
          })
        })
      }
      return { signIn }
    }

    const App = () => {
      const { useState } = React
      const { useForm } = ReactHookForm
      const { Container, Alert, Stack, Card, CardHeader, CardContent, Button, TextField } = MaterialUI
      const [alert, setAlert] = useState(null)
      const [user, setUser] = useState(null)
      const { signIn } = useCognito()
      const { register, handleSubmit } = useForm({})

      const onSubmit = async (data) => {
        try {
          const res = await signIn(data.username, data.password)
          var idToken = res.getIdToken()
          setUser({ payload: idToken.payload, token: idToken.getJwtToken() })
        } catch (error) {
          const { name, message } = error
          switch (name) {
            case 'UserNotFoundException':
            case 'NotAuthorizedException':
              setAlert({ severity: 'error', message: 'ユーザー名またはパスワードが違います。' })
              break
            default:
              setAlert({ severity: 'error', message: name + ' : ' + message })
          }
        }
      }

      return (
        <Container>
          {alert && (
            <Alert severity={alert.severity} onClose={() => { setAlert(null) }}            >
              {alert.message}
            </Alert>
          )}
          <Card sx={{ p: 4, width: '480px', m: '20px auto' }}>
            <CardHeader title="ログイン"></CardHeader>
            <form onSubmit={handleSubmit(onSubmit)}>
              <CardContent>
                <Stack spacing={3}>
                  <TextField label="ユーザーID" type="username" size="small" {...register('username')} />
                  <TextField label="パスワード" type="password" size="small" {...register('password')} />
                  <Button type="submit" color="primary" variant="contained" size="large">
                    ログイン
                  </Button>
                </Stack>
              </CardContent>
            </form>
          </Card >
          <pre>
            {JSON.stringify(user, null, 2)}
          </pre>
        </Container>
      )
    }
    const container = document.getElementById('app')
    const root = ReactDOM.createRoot(container)
    root.render(<App />)
  </script>
</body>
</html>
